name: Unity Build

# ============================================
# ビルド専用ワークフロー（手動実行）
# GitHub UI または CLI から実行してください
#
# 使用例:
#   gh workflow run "Unity Build" --field build_target=StandaloneWindows64
# ============================================

on:
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Build target platform'
        required: true
        default: 'StandaloneWindows64'
        type: choice
        options:
          - StandaloneWindows64
          - StandaloneLinux64
          - StandaloneOSX
          - WebGL
          - Android
          - iOS
          - All
      skip_tests:
        description: 'Skip tests before build'
        required: false
        default: false
        type: boolean
      deploy_webgl:
        description: 'Deploy WebGL to GitHub Pages'
        required: false
        default: false
        type: boolean
      game_environment:
        description: 'Game environment (affects scripting define symbols)'
        required: true
        default: 'Develop'
        type: choice
        options:
          - Develop
          - Staging
          - Review
          - Release

jobs:
  # ============================================
  # 設定読み込み
  # ============================================
  load-config:
    name: Load Configuration
    runs-on: [self-hosted, linux, unity, docker]
    outputs:
      unity_project_path: ${{ steps.config.outputs.UNITY_PROJECT_PATH }}
      cache_key_prefix: ${{ steps.config.outputs.CACHE_KEY_PREFIX }}
      artifact_retention_days: ${{ steps.config.outputs.ARTIFACT_RETENTION_DAYS }}
      build_retention_days: ${{ steps.config.outputs.BUILD_RETENTION_DAYS }}
      build_timestamp: ${{ steps.timestamp.outputs.value }}
      build_profile_type: ${{ steps.profile.outputs.type }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github

      - name: Generate build timestamp
        id: timestamp
        run: echo "value=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Determine Build Profile type
        id: profile
        run: |
          # game_environment に基づいて Build Profile タイプを決定
          # Develop/Staging → Development Profile
          # Review/Release → Release Profile
          case "${{ inputs.game_environment }}" in
            Develop|Staging)
              echo "type=Development" >> $GITHUB_OUTPUT
              ;;
            Review|Release)
              echo "type=Release" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "type=Development" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Load configuration
        id: config
        run: |
          chmod +x .github/scripts/load-config.sh
          .github/scripts/load-config.sh

  # ============================================
  # テスト（スキップ可能）
  # ============================================
  test:
    name: Run Tests
    runs-on: [self-hosted, linux, unity, docker]
    needs: load-config
    if: ${{ !inputs.skip_tests }}
    timeout-minutes: 45
    env:
      UNITY_PROJECT_PATH: ${{ needs.load-config.outputs.unity_project_path }}
      CACHE_KEY_PREFIX: ${{ needs.load-config.outputs.cache_key_prefix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          clean: false

      - name: Setup Library cache (persistent volume)
        run: |
          chmod +x .github/scripts/setup-library-cache.sh
          .github/scripts/setup-library-cache.sh "${{ env.UNITY_PROJECT_PATH }}"

      - name: Setup directories
        run: |
          mkdir -p "${{ github.workspace }}/Logs"
          mkdir -p "${{ github.workspace }}/TestResults"

      - name: Run EditMode tests
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            unity-editor \
              -runTests \
              -batchmode \
              -nographics \
              -projectPath "${{ env.UNITY_PROJECT_PATH }}" \
              -testResults "${{ github.workspace }}/TestResults/editmode-results.xml" \
              -testPlatform EditMode \
              -logFile "${{ github.workspace }}/Logs/editmode-test.log"

      - name: Run PlayMode tests
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            unity-editor \
              -runTests \
              -batchmode \
              -projectPath "${{ env.UNITY_PROJECT_PATH }}" \
              -testResults "${{ github.workspace }}/TestResults/playmode-results.xml" \
              -testPlatform PlayMode \
              -logFile "${{ github.workspace }}/Logs/playmode-test.log"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Test-Results
          path: |
            TestResults/
            Logs/

  # ============================================
  # Windows ビルド
  # ============================================
  build-windows:
    name: Build Windows
    runs-on: [self-hosted, linux, unity, docker]
    needs: [load-config, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (inputs.build_target == 'StandaloneWindows64' || inputs.build_target == 'All')
    timeout-minutes: 60
    env:
      UNITY_PROJECT_PATH: ${{ needs.load-config.outputs.unity_project_path }}
      CACHE_KEY_PREFIX: ${{ needs.load-config.outputs.cache_key_prefix }}
      BUILD_RETENTION_DAYS: ${{ needs.load-config.outputs.build_retention_days }}
      BUILD_TIMESTAMP: ${{ needs.load-config.outputs.build_timestamp }}
      BUILD_PROFILE_TYPE: ${{ needs.load-config.outputs.build_profile_type }}
      GAME_ENVIRONMENT: ${{ inputs.game_environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          clean: false

      - name: Setup Library cache (persistent volume)
        run: |
          chmod +x .github/scripts/setup-library-cache.sh
          .github/scripts/setup-library-cache.sh "${{ env.UNITY_PROJECT_PATH }}"

      - name: Setup directories
        run: |
          mkdir -p "${{ github.workspace }}/Logs"

      - name: Build Windows
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            unity-editor \
              -batchmode \
              -nographics \
              -quit \
              -projectPath "${{ env.UNITY_PROJECT_PATH }}" \
              -activeBuildProfile "Assets/Settings/Build Profiles/Windows - ${{ env.BUILD_PROFILE_TYPE }}.asset" \
              -executeMethod Game.Editor.Build.BuildScript.BuildWindows \
              -buildTimestamp "${{ env.BUILD_TIMESTAMP }}" \
              -logFile "${{ github.workspace }}/Logs/build-windows.log"

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build-${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.UNITY_PROJECT_PATH }}/Builds/CiBuilds/Windows/${{ env.BUILD_TIMESTAMP }}
          retention-days: ${{ fromJSON(env.BUILD_RETENTION_DAYS) }}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Windows-Build-Log-${{ env.BUILD_TIMESTAMP }}
          path: Logs/build-windows.log

  # ============================================
  # Linux ビルド
  # ============================================
  build-linux:
    name: Build Linux
    runs-on: [self-hosted, linux, unity, docker]
    needs: [load-config, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (inputs.build_target == 'StandaloneLinux64' || inputs.build_target == 'All')
    timeout-minutes: 60
    env:
      UNITY_PROJECT_PATH: ${{ needs.load-config.outputs.unity_project_path }}
      CACHE_KEY_PREFIX: ${{ needs.load-config.outputs.cache_key_prefix }}
      BUILD_RETENTION_DAYS: ${{ needs.load-config.outputs.build_retention_days }}
      BUILD_TIMESTAMP: ${{ needs.load-config.outputs.build_timestamp }}
      BUILD_PROFILE_TYPE: ${{ needs.load-config.outputs.build_profile_type }}
      GAME_ENVIRONMENT: ${{ inputs.game_environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          clean: false

      - name: Setup Library cache (persistent volume)
        run: |
          chmod +x .github/scripts/setup-library-cache.sh
          .github/scripts/setup-library-cache.sh "${{ env.UNITY_PROJECT_PATH }}"

      - name: Setup directories
        run: |
          mkdir -p "${{ github.workspace }}/Logs"

      - name: Build Linux
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            unity-editor \
              -batchmode \
              -nographics \
              -quit \
              -projectPath "${{ env.UNITY_PROJECT_PATH }}" \
              -activeBuildProfile "Assets/Settings/Build Profiles/Linux - ${{ env.BUILD_PROFILE_TYPE }}.asset" \
              -executeMethod Game.Editor.Build.BuildScript.BuildLinux \
              -buildTimestamp "${{ env.BUILD_TIMESTAMP }}" \
              -logFile "${{ github.workspace }}/Logs/build-linux.log"

      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: Linux-Build-${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.UNITY_PROJECT_PATH }}/Builds/CiBuilds/Linux/${{ env.BUILD_TIMESTAMP }}
          retention-days: ${{ fromJSON(env.BUILD_RETENTION_DAYS) }}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Linux-Build-Log-${{ env.BUILD_TIMESTAMP }}
          path: Logs/build-linux.log

  # ============================================
  # macOS ビルド
  # ============================================
  build-macos:
    name: Build macOS
    runs-on: [self-hosted, linux, unity, docker]
    needs: [load-config, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (inputs.build_target == 'StandaloneOSX' || inputs.build_target == 'All')
    timeout-minutes: 60
    env:
      UNITY_PROJECT_PATH: ${{ needs.load-config.outputs.unity_project_path }}
      CACHE_KEY_PREFIX: ${{ needs.load-config.outputs.cache_key_prefix }}
      BUILD_RETENTION_DAYS: ${{ needs.load-config.outputs.build_retention_days }}
      BUILD_TIMESTAMP: ${{ needs.load-config.outputs.build_timestamp }}
      BUILD_PROFILE_TYPE: ${{ needs.load-config.outputs.build_profile_type }}
      GAME_ENVIRONMENT: ${{ inputs.game_environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          clean: false

      - name: Setup Library cache (persistent volume)
        run: |
          chmod +x .github/scripts/setup-library-cache.sh
          .github/scripts/setup-library-cache.sh "${{ env.UNITY_PROJECT_PATH }}"

      - name: Setup directories
        run: |
          mkdir -p "${{ github.workspace }}/Logs"

      - name: Build macOS
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            unity-editor \
              -batchmode \
              -nographics \
              -quit \
              -projectPath "${{ env.UNITY_PROJECT_PATH }}" \
              -activeBuildProfile "Assets/Settings/Build Profiles/macOS - ${{ env.BUILD_PROFILE_TYPE }}.asset" \
              -executeMethod Game.Editor.Build.BuildScript.BuildMacOS \
              -buildTimestamp "${{ env.BUILD_TIMESTAMP }}" \
              -logFile "${{ github.workspace }}/Logs/build-macos.log"

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macOS-Build-${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.UNITY_PROJECT_PATH }}/Builds/CiBuilds/macOS/${{ env.BUILD_TIMESTAMP }}
          retention-days: ${{ fromJSON(env.BUILD_RETENTION_DAYS) }}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macOS-Build-Log-${{ env.BUILD_TIMESTAMP }}
          path: Logs/build-macos.log

  # ============================================
  # WebGL ビルド
  # ============================================
  build-webgl:
    name: Build WebGL
    runs-on: [self-hosted, linux, unity, docker]
    needs: [load-config, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (inputs.build_target == 'WebGL' || inputs.build_target == 'All')
    timeout-minutes: 60
    env:
      UNITY_PROJECT_PATH: ${{ needs.load-config.outputs.unity_project_path }}
      CACHE_KEY_PREFIX: ${{ needs.load-config.outputs.cache_key_prefix }}
      BUILD_RETENTION_DAYS: ${{ needs.load-config.outputs.build_retention_days }}
      BUILD_TIMESTAMP: ${{ needs.load-config.outputs.build_timestamp }}
      BUILD_PROFILE_TYPE: ${{ needs.load-config.outputs.build_profile_type }}
      GAME_ENVIRONMENT: ${{ inputs.game_environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          clean: false

      - name: Setup Library cache (persistent volume)
        run: |
          chmod +x .github/scripts/setup-library-cache.sh
          .github/scripts/setup-library-cache.sh "${{ env.UNITY_PROJECT_PATH }}"

      - name: Setup directories
        run: |
          mkdir -p "${{ github.workspace }}/Logs"

      - name: Build WebGL
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            unity-editor \
              -batchmode \
              -nographics \
              -quit \
              -projectPath "${{ env.UNITY_PROJECT_PATH }}" \
              -activeBuildProfile "Assets/Settings/Build Profiles/WebGL Desktop - ${{ env.BUILD_PROFILE_TYPE }}.asset" \
              -executeMethod Game.Editor.Build.BuildScript.BuildWebGL \
              -buildTimestamp "${{ env.BUILD_TIMESTAMP }}" \
              -logFile "${{ github.workspace }}/Logs/build-webgl.log"

      - name: Upload WebGL build
        uses: actions/upload-artifact@v4
        with:
          name: WebGL-Build-${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.UNITY_PROJECT_PATH }}/Builds/CiBuilds/WebGL/${{ env.BUILD_TIMESTAMP }}
          retention-days: ${{ fromJSON(env.BUILD_RETENTION_DAYS) }}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: WebGL-Build-Log-${{ env.BUILD_TIMESTAMP }}
          path: Logs/build-webgl.log

  # ============================================
  # Android ビルド
  # ============================================
  build-android:
    name: Build Android
    runs-on: [self-hosted, linux, unity, docker]
    needs: [load-config, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (inputs.build_target == 'Android' || inputs.build_target == 'All')
    timeout-minutes: 90
    env:
      UNITY_PROJECT_PATH: ${{ needs.load-config.outputs.unity_project_path }}
      CACHE_KEY_PREFIX: ${{ needs.load-config.outputs.cache_key_prefix }}
      BUILD_RETENTION_DAYS: ${{ needs.load-config.outputs.build_retention_days }}
      BUILD_TIMESTAMP: ${{ needs.load-config.outputs.build_timestamp }}
      BUILD_PROFILE_TYPE: ${{ needs.load-config.outputs.build_profile_type }}
      GAME_ENVIRONMENT: ${{ inputs.game_environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          clean: false

      - name: Setup Library cache (persistent volume)
        run: |
          chmod +x .github/scripts/setup-library-cache.sh
          .github/scripts/setup-library-cache.sh "${{ env.UNITY_PROJECT_PATH }}"

      - name: Setup directories
        run: |
          mkdir -p "${{ github.workspace }}/Logs"

      - name: Build Android
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            unity-editor \
              -batchmode \
              -nographics \
              -quit \
              -projectPath "${{ env.UNITY_PROJECT_PATH }}" \
              -activeBuildProfile "Assets/Settings/Build Profiles/Android - ${{ env.BUILD_PROFILE_TYPE }}.asset" \
              -executeMethod Game.Editor.Build.BuildScript.BuildAndroid \
              -buildTimestamp "${{ env.BUILD_TIMESTAMP }}" \
              -logFile "${{ github.workspace }}/Logs/build-android.log"

      - name: Upload Android build
        uses: actions/upload-artifact@v4
        with:
          name: Android-Build-${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.UNITY_PROJECT_PATH }}/Builds/CiBuilds/Android/${{ env.BUILD_TIMESTAMP }}
          retention-days: ${{ fromJSON(env.BUILD_RETENTION_DAYS) }}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Android-Build-Log-${{ env.BUILD_TIMESTAMP }}
          path: Logs/build-android.log

  # ============================================
  # iOS ビルド（Xcode プロジェクト出力）
  # ============================================
  build-ios:
    name: Build iOS (Xcode Project)
    runs-on: [self-hosted, linux, unity, docker]
    needs: [load-config, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (inputs.build_target == 'iOS' || inputs.build_target == 'All')
    timeout-minutes: 90
    env:
      UNITY_PROJECT_PATH: ${{ needs.load-config.outputs.unity_project_path }}
      CACHE_KEY_PREFIX: ${{ needs.load-config.outputs.cache_key_prefix }}
      BUILD_RETENTION_DAYS: ${{ needs.load-config.outputs.build_retention_days }}
      BUILD_TIMESTAMP: ${{ needs.load-config.outputs.build_timestamp }}
      BUILD_PROFILE_TYPE: ${{ needs.load-config.outputs.build_profile_type }}
      GAME_ENVIRONMENT: ${{ inputs.game_environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          clean: false

      - name: Setup Library cache (persistent volume)
        run: |
          chmod +x .github/scripts/setup-library-cache.sh
          .github/scripts/setup-library-cache.sh "${{ env.UNITY_PROJECT_PATH }}"

      - name: Setup directories
        run: |
          mkdir -p "${{ github.workspace }}/Logs"

      - name: Build iOS
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' \
            unity-editor \
              -batchmode \
              -nographics \
              -quit \
              -projectPath "${{ env.UNITY_PROJECT_PATH }}" \
              -activeBuildProfile "Assets/Settings/Build Profiles/iOS - ${{ env.BUILD_PROFILE_TYPE }}.asset" \
              -executeMethod Game.Editor.Build.BuildScript.BuildIOS \
              -buildTimestamp "${{ env.BUILD_TIMESTAMP }}" \
              -logFile "${{ github.workspace }}/Logs/build-ios.log"

      - name: Upload iOS build (Xcode Project)
        uses: actions/upload-artifact@v4
        with:
          name: iOS-Build-${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.UNITY_PROJECT_PATH }}/Builds/CiBuilds/iOS/${{ env.BUILD_TIMESTAMP }}
          retention-days: ${{ fromJSON(env.BUILD_RETENTION_DAYS) }}

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: iOS-Build-Log-${{ env.BUILD_TIMESTAMP }}
          path: Logs/build-ios.log

  # ============================================
  # GitHub Pages デプロイ（WebGL ビルド時のみ）
  # ============================================
  deploy-webgl:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [load-config, build-webgl]
    if: |
      always() &&
      needs.build-webgl.result == 'success' &&
      inputs.deploy_webgl == true
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    env:
      BUILD_TIMESTAMP: ${{ needs.load-config.outputs.build_timestamp }}

    steps:
      - name: Download WebGL build
        uses: actions/download-artifact@v4
        with:
          name: WebGL-Build-${{ env.BUILD_TIMESTAMP }}
          path: ./webgl-build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./webgl-build

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
