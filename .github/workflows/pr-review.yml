name: PR Review

# ============================================
# PR ã‚³ãƒ¡ãƒ³ãƒˆè‡ªå‹•æŠ•ç¨¿ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# C# ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸ PR ã«ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’æŠ•ç¨¿
# ============================================

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.cs'
      - '.editorconfig'
      - 'src/Game.Client/.editorconfig'

jobs:
  # ============================================
  # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ
  # ============================================
  analyze-changes:
    name: Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      cs_files_count: ${{ steps.count.outputs.cs_files }}
      has_unity_changes: ${{ steps.count.outputs.has_unity }}
      has_server_changes: ${{ steps.count.outputs.has_server }}
      has_shared_changes: ${{ steps.count.outputs.has_shared }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Count changed files
        id: count
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸ C# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          cs_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.cs$' || true)
          cs_count=$(echo "$cs_files" | grep -c '\.cs$' || echo "0")
          echo "cs_files=$cs_count" >> $GITHUB_OUTPUT

          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã®å¤‰æ›´ã‚’æ¤œå‡º
          if echo "$cs_files" | grep -q "src/Game.Client/"; then
            echo "has_unity=true" >> $GITHUB_OUTPUT
          else
            echo "has_unity=false" >> $GITHUB_OUTPUT
          fi

          if echo "$cs_files" | grep -q "src/Game.Server/"; then
            echo "has_server=true" >> $GITHUB_OUTPUT
          else
            echo "has_server=false" >> $GITHUB_OUTPUT
          fi

          if echo "$cs_files" | grep -q "src/Game.Shared/"; then
            echo "has_shared=true" >> $GITHUB_OUTPUT
          else
            echo "has_shared=false" >> $GITHUB_OUTPUT
          fi

          echo "Changed C# files: $cs_count"
          echo "$cs_files"

  # ============================================
  # PR ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
  # ============================================
  post-review:
    name: Post Review Comment
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: needs.analyze-changes.outputs.cs_files_count > 0
    permissions:
      pull-requests: write
    steps:
      - name: Post checklist comment
        uses: actions/github-script@v7
        with:
          script: |
            const hasUnity = '${{ needs.analyze-changes.outputs.has_unity_changes }}' === 'true';
            const hasServer = '${{ needs.analyze-changes.outputs.has_server_changes }}' === 'true';
            const hasShared = '${{ needs.analyze-changes.outputs.has_shared_changes }}' === 'true';
            const csCount = '${{ needs.analyze-changes.outputs.cs_files_count }}';

            // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰
            let checklist = `## ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

            **${csCount} å€‹ã® C# ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ã€‚**

            ### å…±é€šãƒã‚§ãƒƒã‚¯
            - [ ] .editorconfig ã«å¾“ã£ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - [ ] å‘½åè¦å‰‡ã®éµå®ˆï¼ˆ\`_\` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€PascalCaseï¼‰
            - [ ] ä¸è¦ãª using ã®å‰Šé™¤
            `;

            if (hasUnity) {
              checklist += `
            ### Unity ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ (Game.Client)
            - [ ] Unity Analyzer ã®è­¦å‘Šå¯¾å¿œ
            - [ ] GetComponent ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆUNT0006ï¼‰
            - [ ] null ãƒã‚§ãƒƒã‚¯ã« \`==\` æ¼”ç®—å­ã‚’ä½¿ç”¨ï¼ˆUNT0002ï¼‰
            - [ ] Camera.main ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆUNT0030ï¼‰
            - [ ] CompareTag ã®ä½¿ç”¨ï¼ˆUNT0015ï¼‰
            `;
            }

            if (hasServer) {
              checklist += `
            ### ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ (Game.Server)
            - [ ] ConfigureAwait(false) ã®ä½¿ç”¨
            - [ ] ä¾‹å¤–å‡¦ç†ã®ç¢ºèª
            - [ ] ãƒ­ã‚°å‡ºåŠ›ã®ç¢ºèª
            `;
            }

            if (hasShared) {
              checklist += `
            ### å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (Game.Shared)
            - [ ] Unity/Server ä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            - [ ] Unity ä¾å­˜ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
            `;
            }

            checklist += `
            ---
            ğŸ“– è©³ç´°ã¯ [CODE_QUALITY_SETUP.md](../docs/CODE_QUALITY_SETUP.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
            `;

            // æ—¢å­˜ã®ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(
              c => c.user.login === 'github-actions[bot]' &&
                   c.body.includes('ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ')
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: checklist
              });
              console.log('Updated existing comment');
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: checklist
              });
              console.log('Created new comment');
            }

  # ============================================
  # ãƒ©ãƒ™ãƒ«è‡ªå‹•ä»˜ä¸
  # ============================================
  add-labels:
    name: Add Labels
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: needs.analyze-changes.outputs.cs_files_count > 0
    permissions:
      pull-requests: write
    steps:
      - name: Add project labels
        uses: actions/github-script@v7
        with:
          script: |
            const hasUnity = '${{ needs.analyze-changes.outputs.has_unity_changes }}' === 'true';
            const hasServer = '${{ needs.analyze-changes.outputs.has_server_changes }}' === 'true';
            const hasShared = '${{ needs.analyze-changes.outputs.has_shared_changes }}' === 'true';

            const labels = [];

            if (hasUnity) labels.push('unity');
            if (hasServer) labels.push('server');
            if (hasShared) labels.push('shared');

            if (labels.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: labels
                });
                console.log(`Added labels: ${labels.join(', ')}`);
              } catch (error) {
                // ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                console.log(`Could not add labels: ${error.message}`);
              }
            }
